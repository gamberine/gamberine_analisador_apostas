<!doctype html>

<html lang="pt-BR">



<head>

  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="shortcut icon" href="allerto_favicon.png">

  <title>Gamberine - Analisador de Apostas</title>

  <meta name="description"
    content="Análise prévia, tabela de apostas e marcador automático do resultado das loterias da Caixa.">

  <link rel="stylesheet" href="assets/css/variables.css">

  <link rel="stylesheet" href="assets/css/app.css">

  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/buttons-enhancement.css">
</head>



<body class="min-h-screen bg-base font-sans text-text antialiased">

  <header class="sticky top-0 z-20 bg-header bg-cover bg-center flex items-center justify-center h-12">

    <div class="mx-auto flex w-full max-w-6xl flex-col px-4 gap-2">

      <h1 class="font-display text-2xl font-semibold text-white leading-5 text-center">Gamberine - Analisador de Apostas

      </h1>

      <div id="oculto-ate-preencher" class="sub hidden flex flex-wrap justify-center gap-2 text-sm text-muted" hidden>

        <span>Dados:</span>

        <span class="font-semibold accent" id="info-lottery">-</span>

        <span class="text-muted">|</span>

        <span>Concurso:</span>

        <span class=" font-semibold accent" id="info-concurso">-</span>

        <span class="text-muted">|</span>

        <span>Data do sorteio:</span>

        <strong class="font-semibold accent" id="info-date">-</strong>

        <button type="button" id="edit-draw-data" class="header-edit-button accent hidden"
          aria-label="Editar dados do sorteio">

          <i class="fi fi-ts-money-check-edit-alt"></i>

        </button>

      </div>

    </div>

  </header>



  <main class="mx-auto flex w-full max-w-6xl flex-col gap-6 px-4 py-10">

    <nav id="wizard-progress" class="wizard-steps" aria-label="Progresso das etapas">

      <button type="button" class="wizard-stepper" data-wizard-progress="1" aria-current="step" data-state="current">

        <span class="wizard-stepper__index">1</span>

        <span class="wizard-stepper__label">Dados</span>

      </button>

      <span class="wizard-divider" aria-hidden="true"></span>

      <button type="button" class="wizard-stepper" data-wizard-progress="2" data-state="locked" disabled>

        <span class="wizard-stepper__index">2</span>

        <span class="wizard-stepper__label">Apostas</span>

      </button>

      <span class="wizard-divider" aria-hidden="true"></span>

      <button type="button" class="wizard-stepper" data-wizard-progress="3" data-state="locked" disabled>

        <span class="wizard-stepper__index">3</span>

        <span class="wizard-stepper__label">Resultados</span>

      </button>

    </nav>

    <section class="wizard-contents space-y-8">



      <!-- step 1 -->

      <div class="wizard-step space-y-4" data-wizard-step="1" aria-hidden="false">

        <fieldset id="draw-data-fieldset" class="rounded-2xl bg-surface shadow-card" data-accordion data-open>

          <legend class="flex items-center justify-between gap-2 px-6 text-sm font-semibold  tracking-wide text-muted">

            <span class="flex items-center gap-2">

              <i class="fi fi-rr-calendar text-accent"></i>

              Dados do sorteio

            </span>

            <button type="button" class="accordion-toggle text-muted transition hover:text-muted" aria-expanded="true">

              <span class="sr-only">Alternar exibição</span>

              <i class="fi fi-rr-angle-small-up text-lg"></i>

            </button>

          </legend>

          <div class="space-y-6 px-6 py-6" data-accordion-panel>

            <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">

              <label class="flex flex-col gap-2 text-sm" for="result-date">

                <span class="text-xs font-semibold uppercase tracking-wide text-muted">Data do sorteio <span
                    class="text-danger">*</span></span>

                <input type="date" id="result-date"
                  class="w-full rounded-xl bg-surface-muted/60 px-4 py-3 text-sm text-white shadow-inner-sm outline-none transition focus-border-accent focus:ring-2 focus-ring-accent/40">

              </label>

              <label class="flex flex-col gap-2 text-sm" for="lottery-select">

                <span class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-muted">

                  Modalidade Aposta

                  <span class="relative"
                    data-tooltip="Com essa informação e o número do concurso, você terá a experiência completa e receber detalhes futuramente.">

                    <i class="fi fi-rr-info text-muted"></i>

                  </span>

                </span>

                <select id="lottery-select"
                  class="w-full appearance-none rounded-xl bg-surface-muted/60 px-4 py-3 text-sm text-white outline-none transition focus-border-accent focus:ring-2 focus-ring-accent/40">

                  <option value="">Selecione</option>

                </select>

              </label>

              <div id="concurso-input-wrapper" class="flex flex-col gap-2 text-sm">

                <label class="flex flex-col gap-2 text-sm" for="concurso-number">

                  <span class="text-xs font-semibold uppercase tracking-wide text-muted">Nº Concurso <span
                      class="text-danger">*</span></span>

                  <input type="text" id="concurso-number" list="concurso-suggestions"
                    placeholder="Informe o numero do concurso" inputmode="numeric"
                    class="w-full rounded-xl bg-surface-muted/60 px-4 py-3 text-sm text-white shadow-inner-sm outline-none transition focus-border-accent focus:ring-2 focus-ring-accent/40">

                </label>

                <datalist id="concurso-suggestions"></datalist>

              </div>

              <label class="flex items-center gap-2 text-sm md:self-end">

                <input type="checkbox" id="toggle-concurso" class="h-4 w-4 rounded accent-accent">

                <span class="leading-relaxed text-muted">Não informar</span>

              </label>

            </div>

            <label class="flex items-center gap-2 text-sm md:self-end">

              <input type="checkbox" id="toggle-concurso" class="h-4 w-4 rounded accent-accent">

              <span class="leading-relaxed text-muted">Não informar</span>

            </label>

          </div>

      </div>

      </div>

      <p class="text-xs text-muted">Preencha a data e a modalidade para habilitar as próximas etapas

        automaticamente.

      </p>

      </div>

      </fieldset>



      </div>

      <!-- step 2  -->

      <div class="wizard-step hidden space-y-6" data-wizard-step="2" id="oculto-ate-preencher-concurso-input-wrapper"
        hidden aria-hidden="true">

        <div class="flex flex-col gap-6 xl:flex-row xl:items-start">

          <fieldset class="rounded-2xl bg-surface shadow-card xl:w-2/5 xl:max-w-[40%]" data-accordion data-open>

            <legend
              class="flex items-center justify-between gap-2 px-6 py-4 text-sm font-semibold uppercase tracking-wide text-muted">

              <span class="flex items-center gap-2">

                <i class="fi fi-rr-sort-numeric-up text-accent"></i>

                Dados da(s) aposta(s)

              </span>

              <button type="button" class="accordion-toggle text-muted transition hover:text-muted"
                aria-expanded="true">

                <span class="sr-only">Alternar exibição</span>

                <i class="fi fi-rr-angle-small-up text-lg"></i>

              </button>

            </legend>

            <div class="space-y-4 px-6 py-6" data-accordion-panel>

              <label class="flex flex-col gap-3 text-sm" for="bets-input">

                <span class="text-xs font-semibold tracking-wide text-white flex flex-col">

                  NÚMEROS APOSTADOS

                  <span class="text-xs font-medium leading-relaxed text-muted flex flex-col"
                    id="bets-input-format">Formato

                    padrão "#01:10-20-30-40-50"</span></span>

                <textarea id="bets-input" rows="2" inputmode="numeric" autocomplete="off"
                  placeholder="Cole ou digite aqui suas apostas"
                  class="min-h-[112px] w-full resize-y rounded-xl bg-surface-muted/60 px-4 py-3 text-sm text-white outline-none transition focus:border-accent focus:ring-2 focus:ring-accent/40"></textarea>

              </label>

              <span class="text-xs leading-relaxed text-muted flex flex-col" id="bets-hint">Para apostas padrão,

                informe: 5

                dezenas (01-80)

                por aposta.

                <span>Cole qualquer formato e nós organizamos automaticamente.</span>

              </span>

            </div>

          </fieldset>

          <fieldset id="bets-card" class="hidden rounded-2xl bg-surface shadow-card xl:flex-1" data-accordion>

            <legend
              class="flex items-center justify-between gap-2 px-6 py-4 text-sm font-semibold uppercase tracking-wide text-muted">

              <span class="flex items-center gap-2">

                <i class="fi fi-rr-play text-accent"></i>

                Ações e processamento

              </span>

              <button type="button" class="accordion-toggle text-muted transition hover:text-muted"
                aria-expanded="false">

                <span class="sr-only">Alternar exibição</span>

                <i class="fi fi-rr-angle-small-down text-lg"></i>

              </button>

            </legend>

            <div class="space-y-6 px-6 py-6" data-accordion-panel hidden>

              <div class="flex flex-wrap items-center justify-between gap-4">

                <p class="text-xs leading-relaxed text-muted max-w-md">

                  Finalize esta etapa gerando a tabela e o link. Também poderá analisar os jogos antes de avaçar para a
                  próxima etapa..</p>

                <div class="w-full ml-auto flex flex-wrap flex-col justify-center items-center gap-3">

                  <button id="process-btn" class="hidden btn btn--rounded" type="button">

                    <i class="fi fi-rr-play-circle"></i>

                    <span>Inserir apostas</span>

                  </button>

                  <button id="analyze-btn" class="hidden btn btn--secondary" type="button">

                    <i class="fi fi-rr-chart-pie"></i>

                    <span>Analisar apostas</span>

                  </button>



                </div>

              </div>

            </div>

          </fieldset>

        </div>

        <!-- <fieldset id="bets-card" class="hidden rounded-2xl bg-surface shadow-card xl:flex-1" data-accordion></fieldset> -->

      </div>

      <fieldset class="wizard-step hidden space-y-6" data-wizard-step="3" hidden aria-hidden="true">

        <div class="flex flex-wrap items-center justify-between gap-3">

          <h2 class="flex items-center gap-2 text-sm font-semibold uppercase tracking-wide text-muted">

            <i class="fi fi-rr-list-check text-accent"></i>

            Resultados e acompanhamento

          </h2>

          <button id="open-results-btn" class="hidden btn btn--outline" type="button">

            <i class="fi fi-rr-star"></i>

            <span>Inserir resultado</span>

          </button>

        </div>

        <fieldset id="analysis-output" class="hidden rounded-xl bg-surface-muted/40 p-4 text-sm text-muted"></fieldset>

        <fieldset id="generated-link-container" class="hidden space-y-3 rounded-xl bg-surface-muted/30 p-4">

          <strong class="text-sm uppercase tracking-wide text-muted">Link gerado</strong>

          <div class="flex flex-col gap-3 md:flex-row md:items-center">

            <input type="text" readonly value="" aria-label="Link gerado"
              class="flex-1 rounded-xl bg-surface px-4 py-2 text-sm text-white outline-none">

            <div class="flex gap-2">

              <button class="btn btn--success" type="button" data-action="open-link">

                <i class="fi fi-rr-external-link"></i>

                <span>Abrir link</span>

              </button>

              <button class="btn btn--ghost" type="button" data-action="copy-link">

                <i class="fi fi-rr-copy"></i>

                <span>Copiar link</span>

              </button>

            </div>

          </div>

        </fieldset>

        <details class="rounded-2xl bg-surface shadow-card" id="bets-accordion" hidden>

          <summary
            class="flex cursor-pointer items-center justify-between gap-4 px-6 py-4 text-sm font-semibold uppercase tracking-wide text-muted">

            <span class="flex items-center gap-2"><i class="fi fi-rr-list-check text-accent"></i>Tabela de

              apostas</span>

            <i class="fi fi-rr-angle-small-down text-lg"></i>

          </summary>

          <div class="space-y-4 px-6 py-6">

            <div id="drawn-highlight" class="hidden rounded-xl bg-accent/10 p-4 text-sm text-muted">

              <h2 id="drawn-highlight-title" class="text-base font-semibold text-white"></h2>

              <div id="drawn-highlight-badges" class="mt-3 flex flex-wrap gap-2"></div>

            </div>

            <div class="overflow-x-auto">

              <table id="bets" class="min-w-full overflow-hidden rounded-xl text-left text-sm">

                <thead class="bg-surface-muted/50 text-xs uppercase tracking-wide text-muted">

                  <tr>

                    <th class="px-4 py-3">#</th>

                    <th class="px-4 py-3">Dezenas</th>

                    <th class="px-4 py-3">Acertos</th>

                  </tr>

                </thead>

                <tbody class="divide-y divide-border/30"></tbody>

              </table>

            </div>

          </div>

        </details>

        <template id="results-template">

          <details class="rounded-2xl bg-surface shadow-card" id="results-accordion" open>

            <summary
              class="flex cursor-pointer items-center justify-between gap-4 px-6 py-4 text-sm font-semibold uppercase tracking-wide text-muted">

              <span class="flex items-center gap-2"><i class="fi fi-rr-star text-accent"></i>Inserir resultado do

                sorteio</span>

              <i class="fi fi-rr-angle-small-down text-lg"></i>

            </summary>

            <div class="flex flex-wrap gap-3 space-y-4 px-6 py-6">

              <label class="flex flex-col gap-2 text-sm" for="drawn">

                <span class="text-xs font-semibold uppercase tracking-wide text-muted">Números sorteados</span>

                <input id="drawn" type="text" placeholder="Ex: 02,16,31,54,78" inputmode="numeric" autocomplete="off"
                  class="w-full rounded-xl bg-surface-muted/60 px-4 py-3 text-sm text-white outline-none transition focus:border-accent focus:ring-2 focus:ring-accent/40">

              </label>

              <button class="btn btn--ghost" type="button" id="clear-drawn-btn">

                <i class="fi fi-rr-broom"></i>

                <span>Limpar</span>

              </button>

              <button type="button" id="apply-drawn-btn" class="btn btn--outline">

                <i class="fi fi-rr-check-circle"></i>

                <span>Aplicar resultado</span>

              </button>

              <!-- <button class="btn btn--outline" type="button" id="search-result-btn" disabled

                  data-tooltip="Em breve">

                  <i class="fi fi-rr-search"></i>

                  <span>Buscar resultado</span>

                </button> -->

              <span id="summary"
                class="inline-flex items-center gap-2 rounded-full border-accent/40 bg-accent/10 px-3 py-1 text-xs font-medium text-accent">Aguardando...</span>

            </div>

          </details>

        </template>

      </fieldset>



      <section id="navegar" class="w-full flex justify-center items-center gap-4 px-2">
        <button type="button" id="criar-acao-voltar" class="btn btn--ghost inline-flex items-center gap-2" disabled
          aria-disabled="true">
          <i class="fi fi-rr-arrow-small-left"></i>
          <span>Voltar</span>
        </button>
        <button type="button" id="wizard-next" class="btn btn--accent inline-flex items-center gap-2" disabled
          aria-disabled="true">
          <span>Prosseguir</span>
          <i class="fi fi-rr-arrow-small-right"></i>
        </button>
        <button id="advance-button" class="hidden btn btn--ghost" type="button" disabled>
          <span>Prosseguir</span>
          <i class="fi fi-rr-arrow-small-right"></i>
        </button>
      </section>

    </section>

  </main>





  <footer class="bg-surface-muted/60 py-6 text-center text-xs text-muted">

    <div class="mx-auto flex w-full max-w-6xl flex-col items-center gap-2 px-4">

      <span>Gamberine © <span id="footer-year"></span>. Organize, acompanhe e compare seus jogos.</span>

    </div>

  </footer>



  <div id="toast-stack" class="pointer-events-none fixed bottom-6 right-6 z-50 flex max-w-xs flex-col gap-3"></div>

  <script>

    const LOTTERY_RULES = {

      default: { numbersPerBet: 5, min: 1, max: 80, pad: 2, label: '5 dezenas (01-80)' },

      'mega-sena': { numbersPerBet: 6, min: 1, max: 60, pad: 2, label: '6 dezenas (01-60)' },

      quina: { numbersPerBet: 5, min: 1, max: 80, pad: 2, label: '5 dezenas (01-80)' },

      lotofacil: { numbersPerBet: 15, min: 1, max: 25, pad: 2, label: '15 dezenas (01-25)' },

      lotomania: { numbersPerBet: 50, min: 0, max: 99, pad: 2, label: '50 dezenas (00-99)' },

      'dupla-sena': { numbersPerBet: 6, min: 1, max: 50, pad: 2, label: '6 dezenas (01-50)' },

      timemania: { numbersPerBet: 10, min: 1, max: 80, pad: 2, label: '10 dezenas (01-80)' },

      'dia-de-sorte': { numbersPerBet: 7, min: 1, max: 31, pad: 2, label: '7 dezenas (01-31)' },

      'super-sete': { numbersPerBet: 7, min: 0, max: 9, pad: 1, label: '7 dígitos (0-9)' },

      loteca: { numbersPerBet: 14, min: 1, max: 3, pad: 1, label: '14 palpites (1-3)' },

      federal: { numbersPerBet: 5, min: 0, max: 9, pad: 1, label: '5 dígitos (0-9)' },

      'mais-milionaria': { numbersPerBet: 6, min: 1, max: 50, pad: 2, label: '6 dezenas (01-50)' }

    };



    const lotteries = [

      { value: 'mega-sena', label: 'Mega-Sena' },

      { value: 'quina', label: 'Quina' },

      { value: 'lotofacil', label: 'Lotofácil' },

      { value: 'lotomania', label: 'Lotomania' },

      { value: 'dupla-sena', label: 'Dupla Sena' },

      { value: 'timemania', label: 'Timemania' },

      { value: 'dia-de-sorte', label: 'Dia de Sorte' },

      { value: 'super-sete', label: 'Super Sete' },

      { value: 'loteca', label: 'Loteca' },

      { value: 'federal', label: 'Loteria Federal' },

      { value: 'mais-milionaria', label: 'Mais Milionária' }

    ];



    let betsData = {};

    let lastGeneratedLink = '';

    const metaData = { date: '', lottery: '', lotteryLabel: '', concurso: '', skipConcurso: false };
    let allowAutoHideDrawSection = true;
    let currentStep = 1;

    function isStep1Complete() {
      return Boolean(metaData.date && metaData.lottery && (metaData.concurso || metaData.skipConcurso));
    }

    function isStep2Complete() {
      return Object.keys(betsData).length > 0;
    }

    function getMaxAvailableStep() {
      if (!isStep1Complete()) return 1;
      if (!isStep2Complete()) return 2;
      return 3;
    }

    function ensureStepWithinBounds() {
      const maxStep = getMaxAvailableStep();
      if (currentStep > maxStep) currentStep = maxStep;
      if (currentStep < 1) currentStep = 1;
      return maxStep;
    }

    function updateWizardContent() {
      document.querySelectorAll('.wizard-step').forEach((section) => {
        const stepValue = parseInt(section.getAttribute('data-wizard-step'), 10);
        if (Number.isNaN(stepValue)) return;
        const isCurrent = stepValue === currentStep;
        section.hidden = !isCurrent;
        section.setAttribute('aria-hidden', String(!isCurrent));
        section.classList.toggle('hidden', !isCurrent);
      });
    }

    function updateWizardSteppers(maxStep) {
      document.querySelectorAll('[data-wizard-progress]').forEach((stepper) => {
        const stepValue = parseInt(stepper.getAttribute('data-wizard-progress'), 10);
        if (Number.isNaN(stepValue)) return;
        const isCurrent = stepValue === currentStep;
        const isUnlocked = stepValue <= maxStep;
        stepper.disabled = !isUnlocked;
        stepper.setAttribute('aria-current', isCurrent ? 'step' : 'false');
        if (!isUnlocked) {
          stepper.dataset.state = 'locked';
        } else if (stepValue < currentStep) {
          stepper.dataset.state = 'completed';
        } else {
          stepper.removeAttribute('data-state');
        }
      });
    }

    function updateNavigationUI(maxStep) {
      const backButton = document.getElementById('criar-acao-voltar');
      const nextButton = document.getElementById('wizard-next');
      if (backButton) {
        const canGoBack = currentStep > 1;
        backButton.disabled = !canGoBack;
        backButton.setAttribute('aria-disabled', String(!canGoBack));
      }
      if (nextButton) {
        let canProceed = false;
        let nextLabel = 'Prosseguir';
        if (currentStep === 1) {
          canProceed = isStep1Complete();
          nextLabel = 'Prosseguir';
        } else if (currentStep === 2) {
          canProceed = isStep2Complete();
          nextLabel = 'Ir para resultados';
        } else if (currentStep === 3) {
          canProceed = isStep2Complete();
          nextLabel = 'Inserir resultado';
        }
        const labelSpan = nextButton.querySelector('span');
        if (labelSpan) labelSpan.textContent = nextLabel;
        nextButton.disabled = !canProceed;
        nextButton.setAttribute('aria-disabled', String(!canProceed));
      }
    }

    function updateWizardUI() {
      const maxStep = ensureStepWithinBounds();
      updateWizardContent();
      updateWizardSteppers(maxStep);
      updateNavigationUI(maxStep);
    }

    function setCurrentStep(step) {
      const maxStep = getMaxAvailableStep();
      currentStep = Math.min(Math.max(step, 1), maxStep);
      if (currentStep === 3 && isStep2Complete()) {
        const betsAccordion = document.getElementById('bets-accordion');
        if (betsAccordion && betsAccordion.hidden) {
          handleAdvance();
        }
      }
      updateWizardUI();
    }

    function bindWizardNavigation() {
      const backButton = document.getElementById('criar-acao-voltar');
      const nextButton = document.getElementById('wizard-next');
      if (backButton) {
        backButton.addEventListener('click', () => {
          if (currentStep > 1) {
            setCurrentStep(currentStep - 1);
          }
        });
      }
      if (nextButton) {
        nextButton.addEventListener('click', () => {
          if (currentStep === 1) {
            if (!isStep1Complete()) {
              showToast('Preencha data, modalidade e o concurso ou marque \"Não informar\" para continuar.', false);
              return;
            }
            setCurrentStep(2);
          } else if (currentStep === 2) {
            if (!isStep2Complete()) {
              showToast('Conclua o processamento das apostas antes de prosseguir.', false);
              return;
            }
            setCurrentStep(3);
          } else if (currentStep === 3) {
            handleInsertResultClick();
          }
        });
      }
      document.querySelectorAll('[data-wizard-progress]').forEach((stepper) => {
        stepper.addEventListener('click', () => {
          const target = parseInt(stepper.getAttribute('data-wizard-progress'), 10);
          if (Number.isNaN(target)) return;
          const maxStep = getMaxAvailableStep();
          if (target <= maxStep) {
            setCurrentStep(target);
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupLotterySelect();
      bindAccordion();
      bindWizardNavigation();
      bindInteractions();
      hydrateFromUrl();
      updateWizardUI();
      updateFooterYear();
    });


    function setupLotterySelect() {

      const select = document.getElementById('lottery-select');

      lotteries.forEach((opt) => {

        const option = document.createElement('option');

        option.value = opt.value;

        option.textContent = opt.label;

        select.append(option);

      });

    }



    function bindAccordion() {

      document.querySelectorAll('[data-accordion]').forEach((fieldset) => {

        const toggle = fieldset.querySelector('.accordion-toggle');

        const panel = fieldset.querySelector('[data-accordion-panel]');

        if (!toggle || !panel) return;

        const initialOpen = fieldset.hasAttribute('data-open');

        if (!initialOpen) {

          panel.hidden = true;

          toggle.setAttribute('aria-expanded', 'false');

          const icon = toggle.querySelector('i');

          if (icon) icon.classList.replace('fi-rr-angle-small-up', 'fi-rr-angle-small-down');

        }

        toggle.addEventListener('click', () => {

          const isOpen = toggle.getAttribute('aria-expanded') === 'true';

          toggle.setAttribute('aria-expanded', String(!isOpen));

          panel.hidden = isOpen;

          const icon = toggle.querySelector('i');

          if (icon) {

            icon.classList.toggle('fi-rr-angle-small-up', !isOpen);

            icon.classList.toggle('fi-rr-angle-small-down', isOpen);

          }

        });

      });

    }



    function bindInteractions() {

      const dateInput = document.getElementById('result-date');

      const lotterySelect = document.getElementById('lottery-select');

      const toggleConcurso = document.getElementById('toggle-concurso');


      const concursoInput = document.getElementById('concurso-number');

      const betsInput = document.getElementById('bets-input');

      const processButton = document.getElementById('process-btn');

      const analyzeButton = document.getElementById('analyze-btn');

      const advanceButton = document.getElementById('advance-button');

      const applyButton = document.getElementById('apply-drawn-btn');

      const clearButton = document.getElementById('clear-drawn-btn');

      const searchButton = document.getElementById('search-result-btn');

      const insertResultButton = document.getElementById('open-results-btn');

      const editDrawButton = document.getElementById('edit-draw-data');



      const now = new Date();

      const localISODate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().split('T')[0];

      if (!dateInput.min || dateInput.min < localISODate) {

        dateInput.min = localISODate;

      }



      const triggerDatePicker = () => {

        if (typeof dateInput.showPicker === 'function') {

          try {

            dateInput.showPicker();

          } catch (err) {

            dateInput.focus();

          }

        } else {

          dateInput.focus();

        }

      };



      dateInput.addEventListener('click', triggerDatePicker);

      dateInput.addEventListener('keydown', (event) => {

        if (event.key === 'Enter' || event.key === ' ') {

          event.preventDefault();

          triggerDatePicker();

        }

      });



      dateInput.addEventListener('input', () => {

        const isValid = validateDateField();

        if (isValid) {

          metaData.date = dateInput.value;

          allowAutoHideDrawSection = true;

          updateHeaderInfo();

        } else {
          metaData.date = '';
          updateHeaderInfo();
        }
        refreshActionVisibility();
        updateWizardUI();
      });

      dateInput.addEventListener('blur', () => {
        if (validateDateField()) {
          metaData.date = dateInput.value;
          allowAutoHideDrawSection = true;
          updateHeaderInfo();
        } else {
          metaData.date = '';
          updateHeaderInfo();
        }
        refreshActionVisibility();
        updateWizardUI();
      });


      lotterySelect.addEventListener('change', () => {

        metaData.lottery = lotterySelect.value;

        metaData.lotteryLabel = getSelectedLotteryLabel();

        updateBetsHelper();

        normalizeCurrentInput();

        if (!toggleConcurso.checked) updateConcursoSuggestions();
        allowAutoHideDrawSection = true;
        updateHeaderInfo();
        refreshActionVisibility();
        updateWizardUI();
      });


      toggleConcurso.addEventListener('change', () => {

        const skip = toggleConcurso.checked;

        metaData.skipConcurso = skip;

        if (skip) {

          concursoInput.value = '';

          concursoInput.setAttribute('disabled', 'true');

          metaData.concurso = '';

        } else {

          concursoInput.removeAttribute('disabled');

          setTimeout(() => concursoInput.focus({ preventScroll: true }), 50);

          updateConcursoSuggestions();

        }

        allowAutoHideDrawSection = false;

        updateHeaderInfo();

        updateWizardUI();

      });




      concursoInput.addEventListener('input', () => {

        metaData.concurso = concursoInput.value.trim();

        metaData.skipConcurso = false;

        if (toggleConcurso.checked) toggleConcurso.checked = false;

        concursoInput.removeAttribute('disabled');

        allowAutoHideDrawSection = true;

        updateHeaderInfo();

        updateWizardUI();

      });




      const normalizeCurrentInput = () => {

        const value = betsInput.value;

        const normalized = normalizeBetsInput(value);

        if (normalized !== value) {

          betsInput.value = normalized;

        }

      };



      ['input', 'paste', 'blur'].forEach((eventName) => {

        betsInput.addEventListener(eventName, () => {

          normalizeCurrentInput();

          refreshActionVisibility();

        });

      });



      processButton.addEventListener('click', processInputs);

      analyzeButton.addEventListener('click', analyzeBets);

      advanceButton.addEventListener('click', handleAdvance);



      applyButton.addEventListener('click', applyDrawn);

      clearButton.addEventListener('click', clearDrawn);

      searchButton.addEventListener('click', (event) => event.stopPropagation());



      if (insertResultButton) {

        insertResultButton.addEventListener('click', handleInsertResultClick);

      }

      if (editDrawButton) {

        editDrawButton.addEventListener('click', () => {

          allowAutoHideDrawSection = false;

          expandDrawSection({ focus: true });

          refreshDrawSectionVisibility();

        });

      }

      updateBetsHelper();

      refreshActionVisibility();

      refreshDrawSectionVisibility();

      updateWizardUI();

    }

    function validateDateField() {

      const dateInput = document.getElementById('result-date');

      if (!dateInput) return false;

      if (!dateInput.value) {

        dateInput.setCustomValidity('Informe a data do sorteio.');

        return false;

      }

      const picked = new Date(dateInput.value + 'T00:00:00');

      if (Number.isNaN(picked.getTime())) {

        dateInput.setCustomValidity('Data inválida.');

        return false;

      }

      const today = new Date();

      today.setHours(0, 0, 0, 0);

      if (picked < today) {

        dateInput.setCustomValidity('Use uma data igual ou posterior a hoje.');

        return false;

      }

      dateInput.setCustomValidity('');

      return true;

    }



    function getActiveLotteryRule() {

      const select = document.getElementById('lottery-select');

      const activeKey = metaData.lottery || (select ? select.value : '');

      return LOTTERY_RULES[activeKey] || LOTTERY_RULES.default;

    }



    function getDrawSectionElements() {

      const fieldset = document.getElementById('draw-data-fieldset');

      if (!fieldset) return {};

      return {

        fieldset,

        panel: fieldset.querySelector('[data-accordion-panel]'),

        toggle: fieldset.querySelector('.accordion-toggle')

      };

    }



    function shouldLockDrawSection() {
      return Boolean(metaData.date && metaData.lottery && (metaData.concurso || metaData.skipConcurso));
    }



    function collapseDrawSection() {

      const { fieldset, panel, toggle } = getDrawSectionElements();

      if (!fieldset) return;

      fieldset.classList.add('hidden');

      fieldset.hidden = true;

      fieldset.setAttribute('aria-hidden', 'true');

      if (panel) panel.hidden = true;

      if (toggle) {

        toggle.setAttribute('aria-expanded', 'false');

        const icon = toggle.querySelector('i');

        if (icon) {

          icon.classList.remove('fi-rr-angle-small-up');

          icon.classList.add('fi-rr-angle-small-down');

        }

      }

    }



    function expandDrawSection(options = {}) {

      const { focus = false } = options;

      const { fieldset, panel, toggle } = getDrawSectionElements();

      if (!fieldset) return;

      fieldset.classList.remove('hidden');

      fieldset.hidden = false;

      fieldset.removeAttribute('aria-hidden');

      if (panel) panel.hidden = false;

      if (toggle) {

        toggle.setAttribute('aria-expanded', 'true');

        const icon = toggle.querySelector('i');

        if (icon) {

          icon.classList.add('fi-rr-angle-small-up');

          icon.classList.remove('fi-rr-angle-small-down');

        }

      }

      if (focus) {

        const dateInput = document.getElementById('result-date');

        if (dateInput) {

          setTimeout(() => dateInput.focus({ preventScroll: true }), 50);

        }

      }

    }



    function refreshDrawSectionVisibility() {

      const editButton = document.getElementById('edit-draw-data');

      const shouldLock = shouldLockDrawSection();

      if (!shouldLock) {

        if (editButton) editButton.classList.add('hidden');

        expandDrawSection();

        return;

      }

      if (allowAutoHideDrawSection) {

        collapseDrawSection();

        if (editButton) editButton.classList.remove('hidden');

        return;

      }

      if (editButton) editButton.classList.add('hidden');

      expandDrawSection();

    }



    function updateBetsHelper() {

      const rule = getActiveLotteryRule();

      const helper = document.getElementById('bets-hint');

      const format = document.getElementById('bets-input-format');

      const textarea = document.getElementById('bets-input');

      const lotteryName = getSelectedLotteryLabel() || metaData.lotteryLabel || 'apostas padrão';

      const rangeMin = pad(rule.min, rule.pad);

      const rangeMax = pad(rule.max, rule.pad);

      const unitLabel = rule.numbersPerBet === 1 ? 'dígito' : 'dezenas';

      if (helper) {

        helper.textContent = `Para ${lotteryName}, informe ${rule.numbersPerBet} ${unitLabel} (${rangeMin}-${rangeMax}) por aposta. Cole qualquer formato e nós organizamos automaticamente.`;

      }

      if (format) {

        const sample = Array.from({ length: rule.numbersPerBet }, (_, index) => pad(index + 1, rule.pad)).join('-');

        format.textContent = `Formato esperado "#01: ${sample}"`;

      }

      if (textarea) {

        textarea.placeholder = `Cole ou digite ${rule.numbersPerBet} ${unitLabel} no intervalo ${rangeMin}-${rangeMax}`;

      }

    }



    function normalizeBetsInput(inputValue) {

      const rule = getActiveLotteryRule();

      const numbers = (inputValue.match(/\d+/g) || [])

        .map((token) => parseInt(token, 10))

        .filter((number) => !Number.isNaN(number) && number >= rule.min && number <= rule.max);

      if (numbers.length === 0) {

        return '';

      }

      const lines = [];

      let current = [];

      numbers.forEach((number) => {

        if (current.length === rule.numbersPerBet) {

          const formatted = current.map((value) => pad(value, rule.pad));

          lines.push(`#${String(lines.length + 1).padStart(2, '0')}: ${formatted.join('-')}`);

          current = [];

        }

        current.push(number);

      });

      if (current.length > 0) {

        const formatted = current.map((value) => pad(value, rule.pad));

        lines.push(`#${String(lines.length + 1).padStart(2, '0')}: ${formatted.join('-')}`);

      }

      return lines.join('\n');

    }



    function processInputs() {

      const betsInput = document.getElementById('bets-input');

      const betsText = betsInput.value.trim();

      const dateInput = document.getElementById('result-date');



      if (!validateDateField()) {

        dateInput.reportValidity();

        return;

      }



      betsData = parseBets(betsText);

      if (Object.keys(betsData).length === 0) {

        showToast('Nenhuma aposta válida encontrada. Utilize o formato sugerido.', false);

        return;

      }



      metaData.date = dateInput.value;

      metaData.lottery = document.getElementById('lottery-select').value;

      metaData.lotteryLabel = getSelectedLotteryLabel();

      const toggle = document.getElementById('toggle-concurso');

      metaData.skipConcurso = Boolean(toggle && toggle.checked);

      metaData.concurso = metaData.skipConcurso ? '' : document.getElementById('concurso-number').value.trim();


      allowAutoHideDrawSection = true;

      updateHeaderInfo();

      updateLink();

      renderRows();

      updateAnalyzeButtonLabel();

      showToast('Apostas processadas com sucesso!', true);

      refreshActionVisibility();

      updateWizardUI();

    }



    function parseBets(text) {

      const rule = getActiveLotteryRule();

      const lines = text.split('\n');

      const parsed = {};

      lines.forEach((line) => {

        if (!line.trim()) return;

        const match = line.match(/#?(\d+)\s*:\s*([\d\s,-]+)/);

        if (!match) return;

        const id = parseInt(match[1], 10);

        const numbers = (match[2].match(/\d+/g) || [])

          .map((token) => parseInt(token, 10))

          .filter((number) => !Number.isNaN(number) && number >= rule.min && number <= rule.max);

        if (numbers.length === rule.numbersPerBet) {

          parsed[id] = numbers;

        }

      });

      return parsed;

    }



    function analyzeBets() {

      if (Object.keys(betsData).length === 0) {

        showToast('Cadastre ao menos uma aposta válida antes de analisar.', false);

        return;

      }

      const rule = getActiveLotteryRule();

      const analysisBox = document.getElementById('analysis-output');

      const allNumbers = new Set();

      Object.values(betsData).forEach((numbers) => numbers.forEach((number) => allNumbers.add(number)));

      const totalBets = Object.keys(betsData).length;

      const totalNumbers = rule.max - rule.min + 1;

      const chanceQuina = Math.min(100, (totalBets / Math.pow(totalNumbers, rule.numbersPerBet)) * 100 * rule.numbersPerBet * 10);

      const chanceQuadra = Math.min(100, chanceQuina * 3);

      const chanceTerno = Math.min(100, chanceQuina * 5);

      const chanceDuque = Math.min(100, chanceQuina * 8);



      analysisBox.innerHTML = `

          <h3 class="mb-2 flex items-center gap-2 text-base font-semibold text-white"><i class="fi fi-rr-stats"></i>Painel rápido</h3>

          <p class="mb-3">Foi identificado <strong>${totalBets}</strong> ${totalBets === 1 ? 'aposta' : 'apostas'} envolvendo <strong>${allNumbers.size}</strong> números únicos.</p>

          <ul class="space-y-1">

            <li>Probabilidade estimada de prêmio principal: <strong>${chanceQuina.toFixed(5)}%</strong>.</li>

            <li>Quadra: ${chanceQuadra.toFixed(3)}% • Terno: ${chanceTerno.toFixed(2)}% • Duque: ${chanceDuque.toFixed(1)}%.</li>

            <li>Revise concentrações e distribuições antes de prosseguir para maximizar cobertura.</li>

          </ul>

        `;

      analysisBox.classList.remove('hidden');

      analysisBox.scrollIntoView({ behavior: 'smooth', block: 'center' });

    }



    function handleAdvance() {
      if (Object.keys(betsData).length === 0) {
        showToast('Conclua o processamento das apostas antes de prosseguir.', false);
        return;
      }
      const betsAccordion = document.getElementById('bets-accordion');
      betsAccordion.hidden = false;
      betsAccordion.open = true;
      showToast('Tabela liberada! Gere o link e acompanhe seus jogos.', true);
      const advanceButtonEl = document.getElementById('advance-button');
      if (advanceButtonEl) {
        advanceButtonEl.classList.add('hidden');
      }
    }



    function handleInsertResultClick(event) {

      if (event) {

        event.preventDefault();

        event.stopPropagation();

      }

      let resultsAccordion = document.getElementById('results-accordion');

      if (!resultsAccordion) {

        const template = document.getElementById('results-template');

        const fragment = template.content.cloneNode(true);

        const betsAccordion = document.getElementById('bets-accordion');

        betsAccordion.parentNode.insertBefore(fragment, betsAccordion.nextSibling);

        resultsAccordion = document.getElementById('results-accordion');

        bindResultsAccordion();

      }

      resultsAccordion.hidden = false;

      resultsAccordion.open = true;

      const betsAccordion = document.getElementById('bets-accordion');

      betsAccordion.open = false;

    }



    function bindResultsAccordion() {

      const applyButton = document.querySelector('#results-accordion #apply-drawn-btn');

      const clearButton = document.querySelector('#results-accordion #clear-drawn-btn');

      const searchButton = document.querySelector('#results-accordion #search-result-btn');

      applyButton.addEventListener('click', applyDrawn);

      clearButton.addEventListener('click', clearDrawn);

      searchButton.addEventListener('click', (event) => event.stopPropagation());

    }



    function renderRows(drawnSet = null) {

      const tbody = document.querySelector('#bets tbody');

      if (!tbody) return;

      tbody.innerHTML = '';

      const keys = Object.keys(betsData).map((key) => parseInt(key, 10)).sort((a, b) => a - b);

      const rule = getActiveLotteryRule();

      keys.forEach((key) => {

        const row = document.createElement('tr');

        row.className = 'bg-surface hover:bg-surface-muted/40 transition';

        const idx = document.createElement('td');

        idx.className = 'px-4 py-3 font-semibold text-muted';

        idx.textContent = '#' + String(key).padStart(2, '0');

        const nums = document.createElement('td');

        nums.className = 'flex flex-wrap items-center gap-2 px-4 py-3';

        const hitsCell = document.createElement('td');

        hitsCell.className = 'px-4 py-3 text-right font-semibold text-muted';

        let hits = 0;

        betsData[key].forEach((number) => {

          const span = document.createElement('span');

          const isHit = drawnSet && drawnSet.has(number);

          span.className = `inline-flex min-w-[2.5rem] items-center justify-center rounded-lg px-2 py-1 text-xs font-semibold ${isHit ? 'border-accent bg-accent/20 text-accent' : 'border-border/40 bg-surface-muted/40 text-muted'}`;

          span.textContent = pad(number, rule.pad);

          nums.appendChild(span);

          if (isHit) hits += 1;

        });

        hitsCell.textContent = hits;

        hitsCell.classList.toggle('text-success', hits > 0);

        row.append(idx, nums, hitsCell);

        tbody.appendChild(row);

      });

    }



    function parseDrawn(input) {

      const rule = getActiveLotteryRule();

      const drawCount = rule.numbersPerBet;

      const tokens = (input.match(/\d+/g) || []).map((token) => parseInt(token, 10))

        .filter((number) => !Number.isNaN(number) && number >= rule.min && number <= rule.max);

      const drawnSet = new Set();

      tokens.slice(0, drawCount).forEach((number) => drawnSet.add(number));

      return drawnSet;

    }



    function applyDrawn() {

      const drawnInput = document.getElementById('drawn');

      if (!drawnInput) return;

      const drawnSet = parseDrawn(drawnInput.value);

      const rule = getActiveLotteryRule();

      if (drawnSet.size !== rule.numbersPerBet) {

        showToast(`Informe exatamente ${rule.numbersPerBet} dezenas válidas.`, false);

        const summary = document.getElementById('summary');

        if (summary) {

          summary.textContent = `Informe ${rule.numbersPerBet} dezenas válidas`;

          summary.className = 'inline-flex items-center gap-2 rounded-full border-danger/40 bg-danger/10 px-3 py-1 text-xs font-medium text-danger';

        }

        return;

      }

      drawnInput.value = Array.from(drawnSet).sort((a, b) => a - b).map((number) => pad(number, rule.pad)).join('-');

      renderRows(drawnSet);

      updateLink(drawnSet);

      const rows = Array.from(document.querySelectorAll('#bets tbody tr'));

      const totals = { 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0 };

      rows.forEach((row) => {

        const count = parseInt(row.lastChild.textContent || '0', 10);

        if (!Number.isNaN(count) && count >= 2) {

          totals[count] = (totals[count] || 0) + 1;

        }

      });

      const summaryText = Object.entries(totals)

        .filter(([, value]) => value > 0)

        .map(([key, value]) => `${key} acertos: ${value}`)

        .join(' • ') || 'Sem acertos registrados';

      const summary = document.getElementById('summary');

      if (summary) {

        summary.textContent = summaryText;

        summary.className = 'inline-flex items-center gap-2 rounded-full border-success/40 bg-success/10 px-3 py-1 text-xs font-medium text-success';

      }



      updateDrawnHighlight(drawnSet, summaryText);

      showToast(summaryText, true);

      logGeneratedLink('resultado', lastGeneratedLink);

    }



    function clearDrawn() {

      const drawnInput = document.getElementById('drawn');

      if (!drawnInput) return;

      drawnInput.value = '';

      const summary = document.getElementById('summary');

      if (summary) {

        summary.textContent = 'Aguardando...';

        summary.className = 'inline-flex items-center gap-2 rounded-full border-accent/40 bg-accent/10 px-3 py-1 text-xs font-medium text-accent';

      }

      renderRows();

      updateLink();

      updateDrawnHighlight(null, '');

    }



    function updateDrawnHighlight(drawnSet, summaryText) {

      const highlight = document.getElementById('drawn-highlight');

      if (!highlight) return;

      if (!drawnSet || drawnSet.size === 0) {

        highlight.classList.add('hidden');

        highlight.querySelector('#drawn-highlight-title').textContent = '';

        highlight.querySelector('#drawn-highlight-badges').innerHTML = '';

        return;

      }

      const rule = getActiveLotteryRule();

      const sorted = Array.from(drawnSet).sort((a, b) => a - b).map((number) => pad(number, rule.pad));

      highlight.querySelector('#drawn-highlight-title').textContent = `Resultado: ${sorted.join(' • ')}`;

      const badgesWrapper = highlight.querySelector('#drawn-highlight-badges');

      badgesWrapper.innerHTML = '';

      summaryText.split('•').map((item) => item.trim()).forEach((item) => {

        if (!item) return;

        const badge = document.createElement('span');

        badge.className = 'inline-flex items-center gap-2 rounded-full border-accent/40 bg-accent/10 px-3 py-1 text-xs font-medium text-accent';

        badge.innerHTML = `<i class="fi fi-rr-badge-check"></i> ${item}`;

        badgesWrapper.appendChild(badge);

      });

      highlight.classList.remove('hidden');

    }



    function updateAnalyzeButtonLabel() {

      const analyzeButton = document.getElementById('analyze-btn');

      if (!analyzeButton) return;

      const total = Object.keys(betsData).length;

      if (total === 0) {

        analyzeButton.innerHTML = '<i class="fi fi-rr-chart-pie"></i><span>Analisar apostas</span>';

        return;

      }

      const label = total === 1 ? 'Analisar aposta' : `Analisar ${total} apostas`;

      analyzeButton.innerHTML = `<i class="fi fi-rr-chart-pie"></i><span>${label}</span>`;

    }



    function updateHeaderInfo() {

      const container = document.getElementById('oculto-ate-preencher');

      if (!container) return;

      const concursoDisplay = metaData.concurso || (metaData.skipConcurso ? 'Não informado' : '-');

      const hasCompleteData = Boolean(metaData.date && metaData.lottery && (metaData.concurso || metaData.skipConcurso));

      if (!hasCompleteData) {

        container.hidden = true;

        container.classList.add('hidden');

        document.getElementById('info-date').textContent = '-';

        document.getElementById('info-lottery').textContent = metaData.lotteryLabel || '-';

        document.getElementById('info-concurso').textContent = concursoDisplay;

        refreshDrawSectionVisibility();

        return;

      }

      const date = new Date(metaData.date + 'T00:00:00');

      const formatted = date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });

      document.getElementById('info-date').textContent = formatted;

      document.getElementById('info-lottery').textContent = metaData.lotteryLabel || '-';

      document.getElementById('info-concurso').textContent = concursoDisplay;

      document.title = `Gamberine - Analisador (${formatted}${metaData.lotteryLabel ? ' • ' + metaData.lotteryLabel : ''})`;

      container.hidden = false;

      container.classList.remove('hidden');

      refreshDrawSectionVisibility();

    }



    function updateLink(drawnSet) {

      const container = document.getElementById('generated-link-container');

      if (Object.keys(betsData).length === 0) {

        container.classList.add('hidden');

        container.querySelector('input').value = '';

        lastGeneratedLink = '';

        return;

      }

      const url = new URL(window.location.href);

      url.search = '';

      const rule = getActiveLotteryRule();

      const betsString = Object.keys(betsData)

        .map((key) => ({ key: parseInt(key, 10), value: betsData[key] }))

        .sort((a, b) => a.key - b.key)

        .map((entry) => entry.value.map((number) => pad(number, rule.pad)).join('-'))

        .join('_');

      url.searchParams.set('bets', betsString);

      if (metaData.date) {

        url.searchParams.set('date', metaData.date);

      }

      if (metaData.lottery) {

        url.searchParams.set('lot', metaData.lottery);

      }

      if (metaData.concurso && !metaData.skipConcurso) {
        url.searchParams.set('conc', metaData.concurso);
      }

      if (drawnSet && drawnSet.size > 0) {

        url.searchParams.set('d', Array.from(drawnSet).sort((a, b) => a - b).map((number) => pad(number, rule.pad)).join(','));

      }

      lastGeneratedLink = url.toString();

      container.classList.remove('hidden');

      const input = container.querySelector('input');

      input.value = lastGeneratedLink;

      bindGeneratedLinkActions(container);

    }



    function bindGeneratedLinkActions(container) {

      const openBtn = container.querySelector('[data-action="open-link"]');

      const copyBtn = container.querySelector('[data-action="copy-link"]');

      if (openBtn) {

        openBtn.addEventListener('click', () => {

          if (!lastGeneratedLink) return;

          window.open(lastGeneratedLink, '_blank', 'noopener');

          logGeneratedLink('abrir', lastGeneratedLink);

        });

      }

      if (copyBtn) {

        copyBtn.addEventListener('click', async () => {

          if (!lastGeneratedLink) return;

          try {

            await navigator.clipboard.writeText(lastGeneratedLink);

            showToast('Link copiado para a área de transferência', true);

            logGeneratedLink('copiar', lastGeneratedLink);

          } catch (err) {

            showToast('Não foi possível copiar automaticamente. Selecione o texto manualmente.', false);

          }

        });

      }

    }



    function refreshActionVisibility() {

      const betsInput = document.getElementById('bets-input');

      if (!betsInput) return;

      const betsText = betsInput.value.trim();

      const draftBets = parseBets(betsText);

      const draftCount = Object.keys(draftBets).length;

      const processedCount = Object.keys(betsData).length;

      const processButton = document.getElementById('process-btn');

      const analyzeButton = document.getElementById('analyze-btn');

      const openResultsButton = document.getElementById('open-results-btn');

      const advanceButton = document.getElementById('advance-button');

      const betsCard = document.getElementById('bets-card');

      const dateInput = document.getElementById('result-date');

      const hasDate = !!(dateInput && dateInput.value);

      const dateIsValid = hasDate ? validateDateField() : false;

      const prerequisitesMet = !!metaData.lottery && dateIsValid;



      const canProcess = draftCount > 0 && prerequisitesMet;

      processButton.classList.toggle('hidden', !canProcess);

      processButton.disabled = !canProcess;

      if (!canProcess) {

        processButton.setAttribute('title', 'Preencha data, modalidade e apostas válidas para prosseguir.');

      } else {

        processButton.removeAttribute('title');

      }



      const shouldShowCard = prerequisitesMet && (draftCount > 0 || processedCount > 0);

      const wasHidden = betsCard.classList.contains('hidden');

      betsCard.classList.toggle('hidden', !shouldShowCard);

      const panel = betsCard.querySelector('[data-accordion-panel]');

      const toggle = betsCard.querySelector('.accordion-toggle');

      if (!shouldShowCard) {

        if (panel && toggle) {

          panel.hidden = true;

          toggle.setAttribute('aria-expanded', 'false');

          const icon = toggle.querySelector('i');

          if (icon) {

            icon.classList.remove('fi-rr-angle-small-up');

            icon.classList.add('fi-rr-angle-small-down');

          }

        }

      } else if (wasHidden) {

        if (panel && toggle) {

          panel.hidden = false;

          toggle.setAttribute('aria-expanded', 'true');

          const icon = toggle.querySelector('i');

          if (icon) {

            icon.classList.remove('fi-rr-angle-small-down');

            icon.classList.add('fi-rr-angle-small-up');

          }

        }

      }



      analyzeButton.classList.toggle('hidden', processedCount === 0);

      openResultsButton.classList.toggle('hidden', processedCount === 0);
      advanceButton.classList.toggle('hidden', processedCount === 0);
      updateWizardUI();
    }





    function showToast(message, success = false) {

      const stack = document.getElementById('toast-stack');

      const toast = document.createElement('div');

      toast.className = `pointer-events-auto flex items-center gap-3 rounded-xl px-4 py-3 text-sm shadow-card transition ${success ? 'border-success/40 bg-success/10 text-success' : 'border-warm/40 bg-warm/10 text-warm'}`;

      toast.innerHTML = `<i class="fi ${success ? 'fi-rr-star' : 'fi-rr-triangle-warning'} text-lg"></i><span class="leading-snug">${message}</span>`;

      stack.appendChild(toast);

      setTimeout(() => {

        toast.style.opacity = '0';

        toast.style.transform = 'translateY(6px)';

        setTimeout(() => toast.remove(), 400);

      }, 3200);

    }



    function logGeneratedLink(action, link) {

      if (!link) return;

      const payload = { action, link, timestamp: new Date().toISOString() };

      try {

        const stored = JSON.parse(localStorage.getItem('gamberine-link-log') || '[]');

        stored.push(payload);

        localStorage.setItem('gamberine-link-log', JSON.stringify(stored));

      } catch (err) {

        console.warn('Não foi possível registrar no storage local.', err);

      }

      if (navigator.sendBeacon) {

        try {

          const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

          navigator.sendBeacon('link-log.txt', blob);

        } catch (err) {

          console.warn('Envio assíncrono indisponível para o log.', err);

        }

      }

    }



    function hydrateFromUrl() {

      const url = new URL(window.location.href);

      const betsParam = url.searchParams.get('bets');

      const dateParam = url.searchParams.get('date');

      const drawnParam = url.searchParams.get('d');

      const lotParam = url.searchParams.get('lot');

      const concParam = url.searchParams.get('conc');



      if (lotParam) {

        const select = document.getElementById('lottery-select');

        select.value = lotParam;

        metaData.lottery = lotParam;

        metaData.lotteryLabel = getSelectedLotteryLabel();

        updateBetsHelper();

      }



      if (dateParam) {

        const dateInput = document.getElementById('result-date');

        dateInput.value = dateParam;

        if (validateDateField()) {

          metaData.date = dateParam;

        }

      }



      if (concParam) {
        const toggle = document.getElementById('toggle-concurso');
        if (toggle) toggle.checked = false;
        const input = document.getElementById('concurso-number');
        if (input) {
          input.removeAttribute('disabled');
          input.value = concParam;
        }
        metaData.concurso = concParam;
        metaData.skipConcurso = false;
      }



      if (betsParam) {

        const betsInput = document.getElementById('bets-input');

        const rule = getActiveLotteryRule();

        const betsArray = betsParam.split('_');

        let text = '';

        betsArray.forEach((chunk, index) => {

          const numbers = chunk.split('-').map((token) => parseInt(token, 10));

          if (numbers.length === rule.numbersPerBet && numbers.every((number) => !Number.isNaN(number))) {

            text += `#${String(index + 1).padStart(2, '0')}: ${numbers.map((number) => pad(number, rule.pad)).join('-')}\n`;

          }

        });

        betsInput.value = text.trim();

      }



      if (betsParam && dateParam) {

        processInputs();

        if (drawnParam) {

          handleInsertResultClick(new Event('click'));

          const drawnInput = document.getElementById('drawn');

          if (drawnInput) {

            drawnInput.value = drawnParam;

            applyDrawn();

          }

        }

      }



      updateHeaderInfo();

      refreshActionVisibility();

      updateWizardUI();

    }



    function getSelectedLotteryLabel() {

      const select = document.getElementById('lottery-select');

      if (!select.value) return '';

      const option = select.querySelector(`option[value="${select.value}"]`);

      return option ? option.textContent : '';

    }



    function pad(number, length = 2) {

      return String(number).padStart(length, '0');

    }



    async function updateConcursoSuggestions() {

      const datalist = document.getElementById('concurso-suggestions');

      if (!datalist) return;

      const toggle = document.getElementById('toggle-concurso');

      if (toggle && toggle.checked) return;

      const lottery = document.getElementById('lottery-select').value || 'geral';

      const date = document.getElementById('result-date').value;

      datalist.innerHTML = '';

      if (!date) return;

      const suggestions = await fetchConcursoSuggestions(lottery, date);

      suggestions.forEach((value) => {

        const option = document.createElement('option');

        option.value = value;

        datalist.appendChild(option);

      });

    }



    function fetchConcursoSuggestions(lottery, date) {

      return new Promise((resolve) => {

        if (!date) {

          resolve([]);

          return;

        }

        const seed = parseInt(date.replace(/-/g, ''), 10) || Date.now();

        const base = (seed % 9000) + 1000;

        const items = [base - 1, base, base + 1].map((number) => Math.max(1, number));

        resolve(items.map(String));

      });

    }



    function updateFooterYear() {

      const footerYear = document.getElementById('footer-year');

      if (footerYear) {

        footerYear.textContent = new Date().getFullYear();

      }

    }

  </script>

</body>



</html>